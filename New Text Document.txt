USE [washer]
GO

/****** Object: Table [dbo].[USERS] Script Date: 28-03-2019 8.29.42 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[USERS] (
    [USERID]       VARCHAR (20)  NOT NULL,
    [USERNAME]     VARCHAR (50)  NOT NULL,
    [USEREMAIL]    VARCHAR (100) NOT NULL,
    [USERMOBILE]   VARCHAR (10)  NOT NULL,
    [LATITUDE]     VARCHAR (20)  NOT NULL,
    [LONGITUDE]    VARCHAR (20)  NOT NULL,
    [USERPASSWORD] BINARY (64)   NOT NULL,
    [WASHING]      BIT           NOT NULL
);


USE [washer]
GO

/****** Object: SqlProcedure [dbo].[usp_SignUp] Script Date: 28-03-2019 8.30.16 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE usp_SignUp
(
@UserName VARCHAR(50),
@UserEmail VARCHAR(100),
@UserMobile VARCHAR(10),
@lat VARCHAR(20),
@lon VARCHAR(20),
@UserPassword VARCHAR(40),
@Washing BIT,
@UserId VARCHAR(20) OUT
)
AS
BEGIN
 DECLARE @LENGTH INT 
 BEGIN TRY
 IF EXISTS (SELECT USERID FROM USERS WHERE USEREMAIL=@UserEmail)
 BEGIN
 SET @UserId='0'
 RETURN -1
 END
 SELECT @LENGTH=LEN(MAX(USERID))-1 FROM USERS
 PRINT(@LENGTH)
 SELECT @UserId='U'+ 
 CAST(CAST(SUBSTRING(MAX(USERID),2,@LENGTH) AS INT)+1 AS CHAR) 
 FROM USERS
 INSERT INTO USERS VALUES(@UserId,@UserName,@UserEmail,@UserMobile,@lat,@lon,HASHBYTES('SHA2_512', @UserPassword),@Washing)
 RETURN 1
 END TRY
 BEGIN CATCH
 SET @UserId='-1'
 RETURN -99
 END CATCH
END
USE [washer]
GO

/****** Object: Scalar Function [dbo].[UFN_LOGIN] Script Date: 28-03-2019 8.30.25 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE FUNCTION UFN_LOGIN(@UserEmail VARCHAR(100),@Password VARCHAR(20))
RETURNS VARCHAR(20)
AS
BEGIN
 DECLARE @USER_ID VARCHAR(20)
 IF NOT EXISTS (SELECT USERID FROM USERS WHERE USEREMAIL=@UserEmail AND USERPASSWORD=HASHBYTES('SHA2_512',@Password))
 RETURN 'NA'
 SELECT @USER_ID=USERID FROM USERS WHERE USEREMAIL=@UserEmail AND USERPASSWORD=HASHBYTES('SHA2_512',@Password)
 RETURN @USER_ID
END
